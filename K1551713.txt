_MYDATA SEGMENT
	STR1	DB	0AH, 0DH, '---------------------$'
	STR2	DB	0AH, 0DH, '  SIMPLE CALCULATOR  $'
	STR3	DB	0AH, 0DH, '  BY ZHANG ZHEN YAN  $'
	STR4	DB	0AH, 0DH, 'S=$'
	STR5	DB	0AH, 0DH, 'Thank you and bye~$'
	MAINANS		DW	9 DUP(0)
	REMAIN		DB	2 DUP(0)
	FLAG		DB	0
_MYDATA	ENDS

; NAME: SHOW
; INSTRUCTION: Print a string using function 9.
; REG OCCUPATION: AX, DX.
; INPUT: Already initialized string.
; OUTPUT: None.

SHOW MACRO STR
	PUSH	AX
	PUSH	DX
	LEA		DX, STR
	MOV		AH, 9
	INT		21H
	POP		DX
	POP		AX
ENDM

; NAME: CRLF
; INSTRUCTION: Start a new line.
; REG OCCUPATION: AX, DX.
; INPUT: None.
; OUTPUT: None.

CRLF MACRO
	PUSH	AX
	PUSH	DX
	MOV		AH, 2
	MOV		DL, 0DH
	INT		21H
	MOV		AH, 2
	MOV		DL, 0AH
	INT		21H
	POP		DX
	POP		AX
ENDM

_CODE SEGMENT
	ASSUME	CS: _CODE, DS: _MYDATA
_MAIN PROC	FAR
	PUSH	DS
	MOV		AX, 0
	PUSH	AX
	MOV		AX, _MYDATA
	MOV		DS, AX
; Main program starts here.
	
; Initialization starts here.
	SHOW	STR1
	CRLF
	SHOW	STR2
	SHOW	STR3
	CRLF
	SHOW	STR1
	MOV		AX, 0
	MOV		BX, 0
	MOV		CX, 0
	MOV		DX, 0
	CRLF
	SHOW	STR4
	LEA		SI, MAINANS		; Initialize SI as index for MAINANS.
	LEA		DI, REMAIN		; Initialize DI as index for REMAIN.
; Initialization ends here.
	
_INPUT:
	MOV	AX, 0100H
	INT	21H

_COMPARE:
	CMP		AL, 0DH
	JE		_FINAL		; Input CR.
	CMP		AL, 2BH
	JE		_PLUS		; Input '+'.
	CMP		AL, 2DH
	JE		_MINUS		; Input '-'.
	CMP		AL, 2AH
	JE		_MTPLY		; Input '*'.
	CMP		AL, 2FH
	JE		_DVIDE		; Input '/'.
	CMP		AL, 30H
	JB		_INPUT		; Illegal inputs < 30H.
	CMP		AL, 39H
	JBE		_DIGITS		; Input 30H ~ 39H.
	JMP		_INPUT		; Illegal inputs > 39H.

_DIGITS:
	CMP		FLAG, 0
	JNE		_INPUT
	AND		AX, 000FH		; Change ascii to number.
	PUSH	AX
	INC		FLAG
	JMP		_INPUT

_PLUS:
	CMP		FLAG, 0
	JE		_INPUT
	POP		AX
	CALL	__PLUS
	JMP		_INPUT

_MINUS:
	CMP		FLAG, 0
	JE		_INPUT
	POP		AX
	CALL	__MINUS
	JMP		_INPUT

_MTPLY:
	CMP		FLAG, 0
	JE		_INPUT
	POP		AX
	CALL	__MTPLY
	JMP		_INPUT

_DVIDE:
	CMP		FLAG, 0
	JE		_INPUT
	POP		AX
	CALL	__DVIDE
	JMP		_INPUT

_FINAL:
	CMP		FLAG, 0
	JE		_INPUT
	POP		AX
	CALL	__FINAL
	SHOW	STR5
; Main program ends here.
	RET
_MAIN	ENDP

; NAME: __PLUS
; INSTRUCTION: Processes responsing '+' input.
; REG OCCUPATION: AX.
; INPUT: AX, SI.
; OUTPUT: MAINANS, FLAG.

__PLUS PROC		NEAR
	CMP		DX, 0
	JE		_PLUSNEXT
	MOV		[DI], DL
	INC		DI
	MOV		DX, 0
_PLUSNEXT:
	MOV		[SI], AX
	ADD		SI, 2
	DEC		FLAG
	RET
__PLUS ENDP

; NAME: __MINUS
; INSTRUCTION: Processes responsing '-' input.
; REG OCCUPATION: AX.
; INPUT: AX.
; OUTPUT: AX.

__MINUS PROC	NEAR
	CMP		DX, 0
	JE		_MINUSNEXT
	MOV		[DI], DL
	INC		DI
	MOV		DX, 0
_MINUSNEXT:
	MOV		[SI], AX
	ADD		SI, 2
_MINUSINPUT:
	MOV		AX, 0100H
	INT		21H
	CMP		AL, 30H
	JB		_MINUSINPUT		; Illegal inputs < 30H.
	CMP		AL, 39H
	JA		_MINUSINPUT		; Illegal inputs > 39H.
	AND		AX, 000FH		; Change ascii to number.
	NEG		AX
	PUSH	AX
	RET
__MINUS ENDP

; NAME: __MTPLY
; INSTRUCTION: Processes responsing '*' input.
; REG OCCUPATION: AX, BX.
; INPUT: AX.
; OUTPUT: AX.

__MTPLY PROC	NEAR
	CMP		DX, 0
	JE		_MTPLYNEXT
	MOV		[DI], DL
	INC		DI
	MOV		DX, 0
_MTPLYNEXT:
	PUSH	BX
	MOV		BX, AX
_MTPLYINPUT:
	MOV		AX, 0100H
	INT		21H
	CMP		AL, 30H
	JB		_MTPLYINPUT		; Illegal inputs < 30H.
	CMP		AL, 39H
	JA		_MTPLYINPUT		; Illegal inputs > 39H.
	AND		AX, 000FH		; Change ascii to number.
	IMUL	AL, BL
	POP		BX
	PUSH	AX
	RET
__MTPLY ENDP

; NAME: __DVIDE
; INSTRUCTION: Processes responsing '/' input.
; REG OCCUPATION: AX, BX, DX.
; INPUT: AX, DX.
; OUTPUT: AX, DX, REMAIN.

__DVIDE PROC	NEAR
	PUSH	BX
	MOV		BX, 10
	IMUL	BL
	ADD		AX, DX
	MOV		DX, 0
	MOV		BX, AX
_DVIDEINPUT:
	MOV		AX, 0100H
	INT		21H
	CMP		AL, 30H
	JB		_DVIDEINPUT		; Illegal inputs < 30H.
	CMP		AL, 39H
	JA		_DVIDEINPUT		; Illegal inputs > 39H.
	AND		AX, 000FH		; Change ascii to number.
	XCHG	AX, BX
	IDIV	BX
	ADD		DX, DX
	CMP		DX, BX
	JB		_DVIDENEXT
	INC		AX				; Rounding.
_DVIDENEXT:
	MOV		BX, 10
	MOV		DX, 0
	IDIV	BX
	POP		BX
	PUSH	AX
	RET
__DVIDE ENDP

; NAME: __FINAL
; INSTRUCTION: Final processing.
; REG OCCUPATION: AX, BX, CX.
; INPUT: AX, SI, DI, MAINANS, REMAIN.
; OUTPUT: FIN.

__FINAL PROC	NEAR
	PUSH	BX
	PUSH	CX
	CMP		DX, 0
	JZ		_FINALNEXT
	MOV		[DI], DL
	INC		DI
	MOV		DX, 0
_FINALNEXT:
	SHOW	STR4
	LEA		BX, MAINANS
_FINALADD:
	CMP		BX, SI
	JE		_FINALADD2
	ADD		AX, [BX]
	ADD		BX, 2
	JMP		_FINALADD
_FINALADD2:
	MOV		BX, 10
	IMUL	BX
_FINALREMAIN:
	CMP		BX, DI
	JE		_FINALREMAIN2
	ADD		AX, [BX]
	INC		BX
	JMP		_FINALREMAIN
_FINALREMAIN2:
	CALL	__PRINTDEC
	POP		CX
	POP		BX
	RET
__FINAL ENDP

; NAME: __PRINTDEC
; INSTRUCTION: Exchange hexadecimal number in AX to decimal and print.
; REG OCCUPATION: AX, BX, CX, DX.
; INPUT: AX.
; OUTPUT: None.

__PRINTDEC PROC	NEAR
	PUSH	BX
	PUSH	CX
	PUSH	DX
	MOV		CX, 0
	MOV		BX, 10
	CMP		AX, 0
	JNL		_CHGLOOP
	NEG		AX
	MOV		DL, 2DH
	MOV		AX, 0200H
	INT		21H
_CHGLOOP:
	MOV		DX, 0
	IDIV	BX
	PUSH	DX
	INC		CX
	CMP		AX, 0
	JNE		_CHGLOOP
_PRINTLOOP:
	CMP		CX, 1
	JNE		_NOPOINT
	MOV		DL, 2EH
	MOV		AX, 0200H
	INT		21H
_NOPOINT:
	POP		DX
	ADD		DL, 30H
	MOV		AX, 0200H
	INT		21H
	LOOP	_PRINTLOOP
	POP		DX
	POP		CX
	POP		BX
	RET
__PRINTDEC ENDP

_CODE ENDS
	END	_MAIN